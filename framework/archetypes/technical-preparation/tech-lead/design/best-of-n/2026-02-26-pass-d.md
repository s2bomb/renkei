# Best-of-N Pass D -- Tech-Lead Doctrine Design Review

**Date**: 2026-02-26  
**Lens**: Operational doctrine and delegation mechanics in current OpenCode runtime  
**Scope**: First doctrine-writing pass guidance for `tech-lead` with interim handoff to `architect-opencode`

---

## Executive Position

The V1 `tech-lead` doctrine should optimize for one job: produce a contract-complete technical-preparation package from an `active` shaped item, then hand off execution ownership cleanly.

This pass recommends a **strict orchestrator posture**:

1. `tech-lead` delegates all specialist artifact creation.
2. `tech-lead` evaluates artifacts against explicit quality gates.
3. `tech-lead` uses bounded retries (max two corrections per specialist output).
4. `tech-lead` escalates unresolved blockers to the decision owner and routes product-framing defects back to `shaper`.
5. `tech-lead` hands package control to `architect-opencode` with explicit acknowledgment semantics.

This aligns with Shape Up's split between shaping and building, preserves builder autonomy (projects not tasks), and enforces capped downside by blocking ambiguous handoffs.

---

## Grounded Runtime Constraints (OpenCode Today)

1. Delegation is explicit via `Task(subagent_type="general")`.
2. Reliable command invocation requires a first-step Skill instruction block.
3. Slash commands are not implicitly expanded inside delegate prompts; delegates must call Skill tool directly.
4. Orchestrator value is gate evaluation and adaptation, not direct artifact authoring.
5. Delegation failures are common when return contracts are implicit.

Therefore, doctrine must be operationally specific about:
- delegation input packet
- return contract per specialist
- acceptance checks
- retry and escalation limits

---

## V1 Doctrine Article Blueprint (Write These First)

Use the standard doctrine set: `process.md`, `orchestration.md`, `pipeline.md`, `output-contract.md`, plus `team-contract.md`.

### 1) `doctrine/process.md` blueprint

Purpose: ordered stage logic and state transitions.

Required sections:
1. **Intake** -- receive `active` shaped artifact + source/evidence paths + appetite/boundaries/no-gos.
2. **Preflight Gate** -- verify shaping packet completeness before delegating technical prep.
3. **Delegation Run** -- launch specialist commands in dependency order.
4. **Synthesis Gate** -- verify coherence across spec/research/api/test/plan.
5. **Package Freeze** -- emit handoff packet with unresolved decisions and accepted risks.
6. **Interim Handoff** -- delegate to `architect-opencode`; require acknowledgment.
7. **Escalation Paths** -- route shaping defects upstream; route strategic decisions to decision owner.

Canonical sequence:

```text
active shape intake
  -> preflight gate
  -> spec-writer + research-codebase (parallel if context complete)
  -> api-designer (depends on spec + research)
  -> test-designer (depends on api design)
  -> create-plan (depends on spec + research + api + test)
  -> synthesis gate
  -> package freeze
  -> architect-opencode handoff + ack
```

### 2) `doctrine/orchestration.md` blueprint

Purpose: exact delegation mechanics in OpenCode runtime.

Required sections:
1. **Default delegation protocol** -- `Task(subagent_type="general")`, first-step Skill invocation, no pre-skill exploration.
2. **Command choreography** -- when to parallelize vs serialize.
3. **Return contracts** -- mandatory fields per specialist.
4. **Quality gates** -- pass/fail criteria per artifact.
5. **Retry policy** -- max two targeted retries.
6. **Escalation policy** -- blocked fields, owner, and escalation payload format.
7. **Verbatim propagation** -- pass stage convictions and scope boundaries unchanged.

### 3) `doctrine/pipeline.md` blueprint

Purpose: interface position and lifecycle boundaries.

Required declaration:

```text
shaper (active item + scaffold)
  -> tech-lead (technical preparation orchestration)
  -> architect-opencode (execution orchestration, interim)
  -> validate-plan / closure loop
```

Include explicit boundary claims:
- `tech-lead` owns preparation quality, not implementation.
- `tech-lead` does not redefine product framing.
- `architect-opencode` owns execution after acknowledgment.

### 4) `doctrine/output-contract.md` blueprint

Purpose: package schema consumed downstream.

V1 required payload fields:
1. `active_workspace_path`
2. `shape_path`
3. `enriched_spec_path`
4. `research_paths[]`
5. `api_design_paths[]`
6. `test_spec_paths[]`
7. `plan_path`
8. `traceability_matrix_path` (requirement -> artifact -> plan phase)
9. `unresolved_decisions[]` (owner + impact + latest-safe-decision-date)
10. `accepted_risks[]` (scope/risk/consequence/mitigation)
11. `handoff_record` (timestamp, sender, receiver, status)

### 5) `doctrine/team-contract.md` blueprint

Purpose: authority and anti-drift boundaries.

Required role clauses:
- `tech-lead`: preparation orchestration + package coherence owner.
- Specialist agents: produce bounded artifacts only.
- `shaper`: product framing owner; receives defect loops.
- Decision owner: resolves strategic ambiguity and acceptance of open risk.
- `architect-opencode`: execution owner after acknowledgment.

---

## Proposed Orchestration Contract (Specialist Delegates)

Use this contract structure for all five specialist delegates.

### Global delegate envelope

Input packet:
- `item_id`
- `shape_path`
- `active_workspace_path`
- `source_paths[]`
- `appetite`
- `no_gos[]`
- `open_assumptions[]`
- `upstream_artifact_paths[]` (as needed)
- `return_contract` (field list)

Execution protocol:
1. `Task(subagent_type="general")`
2. Prompt begins with mandatory first-step Skill invocation block.
3. Explicitly list expected output path and required sections.
4. Demand non-empty blocker list if contract cannot be fulfilled.

### Delegate-specific contracts

1. **`spec-writer`**
   - Inputs: `shape_path`, source corpus, existing project context.
   - Must return: enriched spec with preserved original intent, technical discovery, open questions, file:line references.
   - Gate: no silent reinterpretation of scope or no-gos.

2. **`research-codebase`**
   - Inputs: enriched spec + shape boundaries.
   - Must return: as-is architecture and behavior evidence, patterns to follow, assumptions requiring validation.
   - Gate: claims must be source-cited (file:line) or marked unknown.

3. **`api-designer`**
   - Inputs: enriched spec + research.
   - Must return: module/API contracts, error semantics, invariants, dependency boundaries.
   - Gate: every API is testable without implementation knowledge.

4. **`test-designer`**
   - Inputs: API design + enriched spec + research.
   - Must return: test obligations for every API contract, explicit error-path tests, design-gap findings.
   - Gate: one-to-many mapping from API contracts to tests is complete.

5. **`create-plan`**
   - Inputs: enriched spec + research + API design + test spec.
   - Must return: phased implementation plan with validation obligations, execution graph, "what we're not doing".
   - Gate: every source requirement traces to at least one phase + validation method.

---

## Quality Gates and Bounded Retry/Escalation Policy

### Gate stack

1. **Preflight gate (before specialist delegation)**
   - Active state confirmed.
   - Shape includes problem/appetite/solution/rabbit holes/no-gos.
   - Workspace scaffold + ledgers exist.

2. **Artifact gate (after each specialist output)**
   - Output exists at expected path.
   - Return contract fields are complete.
   - Evidence and boundary compliance checks pass.

3. **Cross-artifact coherence gate (before handoff)**
   - Spec, research, API, tests, and plan do not conflict.
   - Open risks and unresolved decisions are explicit.
   - Traceability matrix is complete.

4. **Handoff gate (to interim execution owner)**
   - Package payload complete.
   - Acknowledgment returned and recorded.

### Retry policy

- Max two correction retries per failed artifact.
- Each retry must include:
  - failed fields
  - concrete defect examples
  - exact correction target
- Do not issue blind reruns.

### Escalation policy

Escalate when:
1. Two retries exhausted.
2. Conflict between product boundary and technical feasibility remains unresolved.
3. Missing decision-owner input blocks correctness.

Escalation payload must include:
- `item_id`
- blocked artifact
- failed gate + missing fields
- attempted corrections
- recommended decision options with consequences

---

## Interim Handoff Contract to `architect-opencode`

### Trigger

Handoff occurs immediately after cross-artifact coherence gate passes.

### Required handoff payload

1. active workspace and shaped artifact paths
2. enriched spec path
3. research path set
4. API design path set
5. test spec path set
6. implementation plan path
7. unresolved decisions list
8. accepted risks list
9. explicit statement of unchanged scope boundaries/no-gos

### Confirmation semantics

`architect-opencode` must return one of three statuses:

1. **`ack-ready`** -- package is sufficient to begin execution.
2. **`ack-blocked`** -- blockers prevent safe execution start.
3. **`ack-needs-decision`** -- execution start depends on decision-owner ruling.

Required response fields:
- `status`
- `received_artifacts[]`
- `missing_or_conflicting_fields[]`
- `first_execution_step`
- `blockers[]` (if any)

Doctrine rule: handoff is incomplete until a valid acknowledgment record is appended to the item ledger.

---

## Exact Shaper Doctrine Adjustments for New Handoff Target

Current shaper doctrine points active handoff to `architect-opencode`. For `tech-lead` introduction, make these exact changes.

1. **`framework/archetypes/product/shaper/doctrine/process.md`**
   - Step 8 target: change `architect-opencode` -> `tech-lead`.
   - Keep same payload fields; add explicit note that `tech-lead` owns technical-preparation orchestration.

2. **`framework/archetypes/product/shaper/doctrine/orchestration.md`**
   - Product Team Contract: replace post-activation owner from `architect-opencode` to `tech-lead`.
   - Delegation trigger: "Delegate to `tech-lead` immediately after active confirmation and scaffold/ledger completion."
   - Add clause: `tech-lead` will perform interim downstream handoff to `architect-opencode`.

3. **`framework/archetypes/product/shaper/doctrine/pipeline.md`**
   - Pipeline string: insert `tech-lead` between shaper and `architect-opencode`.
   - Active handoff target section: `tech-lead` becomes direct consumer of active shaped items.

4. **`framework/archetypes/product/shaper/doctrine/team-contract.md`**
   - Member responsibilities:
     - `tech lead`: change from advisory-only feasibility to active technical-preparation ownership after activation.
     - `architect-opencode`: execution-only owner after `tech-lead` handoff.

5. **`framework/archetypes/product/shaper/doctrine/output-contract.md`**
   - Downstream Contract section:
     - handoff-ready target becomes `tech-lead`.
     - required handoff payload adds explicit appetite/no-go continuity and active workspace paths.

6. **`framework/archetypes/product/shaper/references/template.md`**
   - Handoff Packet `Target orchestrator`: set to `tech-lead`.
   - Optionally add `Interim downstream target: architect-opencode` to preserve transition clarity.

---

## Risk Table -- Runtime Failures and Guardrails

| Failure mode | Likely cause | Early signal | Guardrail | Escalation owner |
|---|---|---|---|---|
| Delegate skips Skill invocation | Weak prompt discipline | Generic output, wrong format | Mandatory first-step block in every Task prompt | tech-lead |
| Spec silently rewrites product intent | Boundary drift | No-gos missing or reinterpreted | Boundary compliance gate against `shape.md` | shaper + decision owner |
| Research outputs recommendations instead of as-is findings | Role confusion | SHOULD-language without evidence | Evidence-only contract + cite-or-unknown rule | tech-lead |
| API design under-specifies errors | Surface-first drafting | Missing error contracts | API gate requires error semantics per endpoint | tech-lead |
| Test spec does not trace to API contracts | Incomplete test design | Coverage holes | Contract->test trace map required | tech-lead |
| Plan phases not validation-bounded | Vague planning | "run tests" generic language | Phase gate requires concrete validation code/commands | tech-lead |
| Infinite iterate loop | No retry cap | Third+ rerun with same failure | Hard cap at two retries then escalate | decision owner |
| Premature handoff to execution | Schedule pressure | Missing artifacts at handoff | Handoff gate with required payload checklist | tech-lead |
| `architect-opencode` starts with ambiguous package | Weak ack semantics | No explicit status response | Enforce `ack-ready|ack-blocked|ack-needs-decision` statuses | tech-lead + architect-opencode |
| Product defect patched in technical prep | Stage collapse | New framing appears in tech docs | Route-back rule: misframing goes to shaper | shaper |

---

## Doctrine-Writing Notes for Next Agent

When drafting first doctrine articles from this pass:

1. Keep anti-identity explicit: `tech-lead` does not implement code and does not reopen shaping by default.
2. Encode runtime truth, not idealized future runtime.
3. Write every delegation clause with concrete input/return contracts.
4. Keep retry/escalation policy numeric and enforceable.
5. Make handoff acknowledgment a required state transition, not a courtesy message.

This yields a doctrine that is executable in current OpenCode and ready for staged split from `architect-opencode`.
